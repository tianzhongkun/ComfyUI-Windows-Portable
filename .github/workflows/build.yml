name: "Build & Upload Package"

on:
  workflow_dispatch: # 手动触发工作流

jobs:
  build_upload:
    permissions:
        contents: write
        packages: write
        pull-requests: read
    runs-on: windows-latest
    steps:
        - uses: actions/checkout@v4

        - name: Stage 1 Gathering Dependencies
          shell: bash
          working-directory: builder
          run: bash stage1.sh

        - name: Stage 2 Assembling Repositories
          shell: bash
          working-directory: builder
          run: bash stage2.sh

        - name: Stage 3 Compressing Package
          shell: bash
          working-directory: builder
          run: bash stage3.sh

        - name: Upload archive to release
          uses: softprops/action-gh-release@v2
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            files: |  # ✅ 正确缩进 (必须对齐)
              builder/*.7z
              builder/*.zip
            generate_release_notes: true
            tag_name: "build-${{ github.run_id }}"  # ✅ 已修复引号闭合